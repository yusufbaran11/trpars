name: TRPars Build

on:
  workflow_dispatch:
    inputs:
      build_name:
        description: 'Build adı (opsiyonel)'
        required: false
        default: 'Manual Build'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        dnf install -y \
          lorax \
          pykickstart \
          anaconda-tui \
          git \
          curl

    - name: Create Build Directories
      run: |
        mkdir -p output
        mkdir -p iso_output/logs
        mkdir -p artifacts

    - name: Validate Kickstart
      run: |
        echo "Kickstart dosyası doğrulanıyor..."
        ksvalidator kickstart/trpars.ks
        echo "✓ Doğrulama başarılı!"

    - name: Build ISO Image
      run: |
        echo "ISO imajı oluşturuluyor..."
        lorax \
          -p "TRPars" \
          -v "26.0-Beta" \
          -r "26.0-Beta" \
          --ks kickstart/trpars.ks \
          -o output/ \
          ./iso_output 2>&1 | tee iso_output/logs/build.log
        echo "✓ ISO oluşturuldu!"

    - name: Check ISO File
      run: |
        if [ -f "iso_output/images/boot.iso" ]; then
          echo "✓ ISO dosyası başarıyla oluşturuldu"
          ls -lh iso_output/images/boot.iso
        else
          echo "✗ ISO dosyası bulunamadı!"
          ls -la iso_output/
          exit 1
        fi

    - name: Generate Checksums
      run: |
        cd iso_output/images
        sha256sum boot.iso > TRPars-26.0-Beta.iso.sha256
        md5sum boot.iso > TRPars-26.0-Beta.iso.md5
        echo "✓ Checksumlar oluşturuldu"
        ls -lh

    - name: Prepare Artifacts
      run: |
        echo "Artifact'lar hazırlanıyor..."
        cp iso_output/images/boot.iso artifacts/ || true
        cp iso_output/images/*.sha256 artifacts/ || true
        cp iso_output/images/*.md5 artifacts/ || true
        cp iso_output/logs/* artifacts/ || true
        ls -la artifacts/

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: iso_output/logs/
        retention-days: 14
        if-no-files-found: ignore

    - name: Upload ISO and Checksums
      uses: actions/upload-artifact@v4
      with:
        name: TRPars-26.0-Beta-ISO
        path: artifacts/
        retention-days: 90
        if-no-files-found: error

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "╔════════════════════════════════════╗"
        echo "║   TRPars Build Özeti                ║"
        echo "╠════════════════════════════════════╣"
        echo "║ Sürüm: 26.0 Beta                   ║"
        echo "║ Tarih: $(date '+%Y-%m-%d %H:%M')   ║"
        echo "║ Status: Build Tamamlandı           ║"
        echo "╚════════════════════════════════════╝"
        echo ""
