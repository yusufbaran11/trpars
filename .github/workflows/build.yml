name: TRPars Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        echo "Bağımlılıklar yükleniyor..."
        dnf install -y \
          pykickstart \
          pungi \
          git \
          curl \
          createrepo_c

    - name: Create Build Directories
      run: |
        echo "Dizinler oluşturuluyor..."
        rm -rf /tmp/trpars-build /tmp/pungi-work /tmp/logs
        mkdir -p /tmp/logs /tmp/pungi-work
        mkdir -p artifacts
        echo "✓ Hazır"

    - name: Validate Kickstart
      run: |
        echo "Kickstart doğrulanıyor..."
        ksvalidator kickstart/trpars.ks
        echo "✓ Başarılı"

    - name: Create Pungi Configuration
      run: |
        echo "Pungi konfigürasyonu oluşturuluyor..."
        
        cat > /tmp/pungi.conf << 'EOF'
[pungi]
product_name = TRPars
version = 26.0
release_name = Beta
release_version = 26.0-Beta

# Output
output_dir = /tmp/trpars-build
working_dir = /tmp/pungi-work

# Architecture
architectures = x86_64

# Variants
variants = Server,Client

# Repository
pkgset_source = koji
koji_profile = koji

# Buildinstall
buildinstall_method = lorax

# Images
create_iso = True
create_unified_iso = False
create_jigdo = False

[variant-Server]
name = Server
type = variant
uid = Server

[variant-Client]
name = Client
type = variant
uid = Client
EOF
        
        cat /tmp/pungi.conf

    - name: Build with Pungi
      run: |
        echo "Pungi ile ISO oluşturuluyor..."
        set +e
        
        pungi-koji \
          --config /tmp/pungi.conf \
          --logdir /tmp/logs \
          2>&1 | tee /tmp/logs/pungi-build.log
        
        BUILD_STATUS=$?
        echo ""
        echo "Pungi exit code: $BUILD_STATUS"
        set -e

    - name: Check Output
      run: |
        echo "Çıktı kontrol ediliyor..."
        echo ""
        echo "=== /tmp/trpars-build ==="
        ls -lah /tmp/trpars-build/ 2>/dev/null || echo "Bulunamadı"
        
        echo ""
        echo "=== ISO dosyaları ==="
        find /tmp/trpars-build -name "*.iso" -type f -ls 2>/dev/null || echo "ISO yok"
        
        echo ""
        echo "=== Tüm dosyalar ==="
        find /tmp/trpars-build -type f 2>/dev/null | head -30

    - name: Show Logs
      if: always()
      run: |
        echo "=== Build Log (son 300 satır) ==="
        tail -300 /tmp/logs/pungi-build.log 2>/dev/null || echo "Log yok"

    - name: Copy ISO
      if: always()
      run: |
        echo "ISO kopyalanıyor..."
        
        # ISO'yu ara ve kopyala
        find /tmp/trpars-build -name "*.iso" -type f -exec cp {} artifacts/ \;
        
        # Log'ları da kopyala
        cp /tmp/logs/* artifacts/ 2>/dev/null || true
        
        echo "Artifact içeriği:"
        ls -lah artifacts/

    - name: Generate Checksums
      if: always()
      run: |
        cd artifacts
        for iso in *.iso; do
          if [ -f "$iso" ]; then
            sha256sum "$iso" > "$iso.sha256"
            md5sum "$iso" > "$iso.md5"
            echo "✓ $iso için checksumlar oluşturuldu"
          fi
        done
        ls -lh *.iso* 2>/dev/null || echo "ISO yok"

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: /tmp/logs/
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload ISO
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TRPars-26.0-Beta-ISO
        path: artifacts/
        retention-days: 90
        if-no-files-found: ignore

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "╔════════════════════════════════════╗"
        echo "║   TRPars 26.0 Beta Build Summary   ║"
        echo "╠════════════════════════════════════╣"
        echo "║ Tarih: $(date '+%Y-%m-%d %H:%M')   ║"
        echo "║ Build Tamamlandı                   ║"
        echo "╚════════════════════════════════════╝"
        echo ""
