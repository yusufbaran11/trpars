name: TRPars Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        echo "Bağımlılıklar yükleniyor..."
        dnf install -y \
          lorax \
          pykickstart \
          anaconda \
          anaconda-core \
          git \
          curl

    - name: Clean and Prepare Directories
      run: |
        echo "Dizinler temizleniyor..."
        rm -rf /tmp/trpars-build
        rm -rf /tmp/work
        rm -rf /tmp/cache
        rm -rf /tmp/logs
        
        mkdir -p /tmp/logs
        mkdir -p artifacts
        
        echo "✓ Dizinler hazır"

    - name: Validate Kickstart
      run: |
        echo "Kickstart dosyası doğrulanıyor..."
        ksvalidator kickstart/trpars.ks
        echo "✓ Doğrulama başarılı"

    - name: Build ISO Image
      run: |
        echo "ISO imajı oluşturuluyor..."
        set +e
        
        lorax \
          --product=TRPars \
          --version=26.0-Beta \
          --release=26.0-Beta \
          --logfile=/tmp/logs/lorax.log \
          --tmp=/tmp/work \
          --cachedir=/tmp/cache \
          /tmp/trpars-build 2>&1 | tee /tmp/logs/build.log
        
        BUILD_STATUS=$?
        echo ""
        echo "Build exit code: $BUILD_STATUS"
        set -e

    - name: Check Build Output
      run: |
        echo "Build output kontrol ediliyor..."
        echo ""
        echo "=== /tmp/trpars-build içeriği ==="
        ls -lah /tmp/trpars-build/ 2>/dev/null || echo "Klasör bulunamadı"
        
        echo ""
        echo "=== İmaj dosyaları ==="
        find /tmp/trpars-build -name "*.iso" -type f 2>/dev/null | while read file; do
          ls -lh "$file"
        done || echo "ISO bulunamadı"
        
        echo ""
        echo "=== Tüm dosyalar (ilk 30) ==="
        find /tmp/trpars-build -type f 2>/dev/null | head -30

    - name: Show Build Logs
      if: always()
      run: |
        echo "=== Build Log (son 150 satır) ==="
        if [ -f /tmp/logs/build.log ]; then
          tail -150 /tmp/logs/build.log
        else
          echo "Build log bulunamadı"
        fi
        
        echo ""
        echo "=== Lorax Log (son 150 satır) ==="
        if [ -f /tmp/logs/lorax.log ]; then
          tail -150 /tmp/logs/lorax.log
        else
          echo "Lorax log bulunamadı"
        fi

    - name: Copy Artifacts
      if: always()
      run: |
        echo "Dosyalar kopyalanıyor..."
        
        # Boot.iso'yu ara
        if [ -f "/tmp/trpars-build/images/boot.iso" ]; then
          cp /tmp/trpars-build/images/boot.iso artifacts/
          echo "✓ boot.iso kopyalandı"
        else
          echo "⚠ boot.iso bulunamadı"
        fi
        
        # Tüm ISO dosyalarını ara ve kopyala
        find /tmp/trpars-build -name "*.iso" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
        
        # Log dosyalarını kopyala
        cp /tmp/logs/* artifacts/ 2>/dev/null || true
        
        echo ""
        echo "Artifact içeriği:"
        ls -lah artifacts/

    - name: Generate Checksums
      if: always()
      run: |
        if [ -f "artifacts/boot.iso" ]; then
          cd artifacts
          sha256sum boot.iso > TRPars-26.0-Beta.iso.sha256
          md5sum boot.iso > TRPars-26.0-Beta.iso.md5
          echo "✓ Checksumlar oluşturuldu"
          ls -lh
        else
          echo "⚠ boot.iso bulunamadı, checksum oluşturulamadı"
        fi

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: /tmp/logs/
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload ISO
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TRPars-26.0-Beta-ISO
        path: artifacts/
        retention-days: 90
        if-no-files-found: ignore

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "╔════════════════════════════════════════╗"
        echo "║      TRPars 26.0 Beta Build Özeti      ║"
        echo "╠════════════════════════════════════════╣"
        echo "║ Tarih: $(date '+%Y-%m-%d %H:%M:%S')     ║"
        echo "║ Durum: Build Tamamlandı                ║"
        echo "║ Artifact'lar: artifacts/ klasöründe    ║"
        echo "╚════════════════════════════════════════╝"
        echo ""
