name: TRPars 26.0 Beta Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Paketler yükle
        run: sudo apt-get update && sudo apt-get install -y debootstrap squashfs-tools xorriso
      
      - name: Dizinler oluştur
        run: mkdir -p build/chroot build/iso/boot/grub build/iso/live output
      
      - name: Debian rootfs oluştur
        run: sudo debootstrap --arch amd64 --variant=minbase trixie build/chroot http://deb.debian.org/debian
      
      - name: Kernel kur
        run: sudo chroot build/chroot apt-get update && sudo chroot build/chroot apt-get install -y linux-image-amd64 grub-pc-bin
      
      - name: Cinnamon kur
        run: sudo chroot build/chroot apt-get install -y cinnamon lightdm lightdm-gtk-greeter xserver-xorg
      
      - name: Uygulamalar kur
        run: sudo chroot build/chroot apt-get install -y chromium thunderbird libreoffice vlc gimp audacity gedit nautilus gparted synaptic htop curl wget git fonts-liberation fonts-dejavu fonts-noto locales
      
      - name: Locale ayarla
        run: sudo chroot build/chroot sed -i 's/^# tr_TR.UTF-8/tr_TR.UTF-8/' /etc/locale.gen && sudo chroot build/chroot locale-gen tr_TR.UTF-8
      
      - name: Kullanıcı oluştur
        run: sudo chroot build/chroot useradd -m -s /bin/bash trpars && sudo chroot build/chroot usermod -aG sudo trpars && echo "trpars:trpars" | sudo chroot build/chroot chpasswd
      
      - name: Hostname ayarla
        run: echo "trpars" | sudo tee build/chroot/etc/hostname > /dev/null
      
      - name: LightDM config
        run: |
          sudo mkdir -p build/chroot/etc/lightdm/lightdm.conf.d
          sudo tee build/chroot/etc/lightdm/lightdm.conf.d/01_trpars.conf > /dev/null << 'LIGHTDMEOF'
          [General]
          session=cinnamon
          autologin-user=trpars
          LIGHTDMEOF
      
      - name: Temizle
        run: sudo chroot build/chroot apt-get autoremove -y && sudo chroot build/chroot apt-get clean -y
      
      - name: Squashfs oluştur
        run: sudo mksquashfs build/chroot build/iso/live/filesystem.squashfs -comp xz -e boot
      
      - name: Boot dosyaları kopyala
        run: sudo cp build/chroot/boot/vmlinuz-* build/iso/boot/vmlinuz 2>/dev/null || true && sudo cp build/chroot/boot/initrd.img-* build/iso/boot/initrd.img 2>/dev/null || true && sudo chown -R $USER:$USER build/iso/
      
      - name: GRUB config oluştur
        run: |
          tee build/iso/boot/grub/grub.cfg > /dev/null << 'GRUBEOF'
          set default=0
          set timeout=5
          menuentry "TRPars 26.0 Beta" {
            linux /boot/vmlinuz boot=live live-media-path=/live
            initrd /boot/initrd.img
          }
          GRUBEOF
      
      - name: ISO oluştur
        run: xorriso -as mkisofs -iso-level 3 -c boot.cat -b boot/grub/grub.cfg -no-emul-boot -boot-load-size 4 -boot-info-table -output output/TRPars-26.0-Beta-amd64.iso build/iso/
      
      - name: Checksum oluştur
        run: cd output && sha256sum TRPars-26.0-Beta-amd64.iso > TRPars-26.0-Beta-amd64.iso.sha256
      
      - name: Info dosyası oluştur
        run: |
          tee output/README.txt > /dev/null << 'READMEEOF'
          TRPars 26.0 Beta
          ================
          
          Dağıtım: Debian 13.2 Tabanlı
          Masaüstü: Cinnamon
          Amaç: Linux'a yeni geçenlere kolaylık sağlamak
          
          Kurulu Yazılımlar:
          - Chromium (Web tarayıcı)
          - Thunderbird (E-posta)
          - LibreOffice (Ofis)
          - VLC (Video)
          - GIMP (Resim düzenleyici)
          - Audacity (Ses düzenleyici)
          - Gparted (Disk bölümlendirme)
          
          Varsayılan Kullanıcı: trpars
          Şifre: trpars
          
          Kurulum:
          1. USB'ye yazın: sudo dd if=TRPars-26.0-Beta-amd64.iso of=/dev/sdX bs=4M
          2. USB'den boot edin
          3. Sisteme Kur
          READMEEOF
      
      - name: Artifacts upload
        uses: actions/upload-artifact@v4
        with:
          name: TRPars-26.0-Beta
          path: output/
          retention-days: 90
      
      - name: Özet
        run: echo "✅ Build tamamlandı!"
