name: TRPars Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        echo "Bağımlılıklar yükleniyor..."
        dnf install -y \
          lorax \
          pykickstart \
          anaconda \
          anaconda-core \
          git \
          curl

    - name: Create Directories
      run: |
        mkdir -p /tmp/trpars-build
        mkdir -p /tmp/logs
        mkdir -p artifacts

    - name: Validate Kickstart
      run: |
        echo "Kickstart dosyası doğrulanıyor..."
        ksvalidator kickstart/trpars.ks
        echo "✓ Doğrulama başarılı"

    - name: Copy Kickstart to Proper Location
      run: |
        echo "Kickstart dosyası hazırlanıyor..."
        cp kickstart/trpars.ks /tmp/trpars.ks
        ls -lh /tmp/trpars.ks

    - name: Build ISO Image
      run: |
        echo "ISO imajı oluşturuluyor..."
        set +e
        
        lorax \
          --product=TRPars \
          --version=26.0-Beta \
          --release=26.0-Beta \
          --repo=https://mirrors.fedoraproject.org/mirrorlist?repo=fedora-43 \
          --logfile=/tmp/logs/lorax.log \
          --workdir=/tmp/work \
          --cachedir=/tmp/cache \
          /tmp/trpars-build 2>&1 | tee /tmp/logs/build.log
        
        BUILD_STATUS=$?
        echo "Build status: $BUILD_STATUS"
        set -e

    - name: Check Build Output
      run: |
        echo "Build output kontrol ediliyor..."
        echo ""
        echo "=== /tmp/trpars-build içeriği ==="
        ls -la /tmp/trpars-build/ || echo "Klasör bulunamadı"
        
        echo ""
        echo "=== İmaj dosyaları ==="
        find /tmp/trpars-build -name "*.iso" -type f -ls 2>/dev/null || echo "ISO bulunamadı"
        
        echo ""
        echo "=== Tüm dosyalar ==="
        find /tmp/trpars-build -type f -ls 2>/dev/null | head -20

    - name: Show Build Logs
      if: always()
      run: |
        echo "=== Build Log (son 100 satır) ==="
        tail -100 /tmp/logs/build.log 2>/dev/null || echo "Log yok"
        
        echo ""
        echo "=== Lorax Log (son 100 satır) ==="
        tail -100 /tmp/logs/lorax.log 2>/dev/null || echo "Log yok"

    - name: Copy ISO Files
      if: always()
      run: |
        echo "İmaj dosyaları kopyalanıyor..."
        
        # Boot.iso'yu ara
        if [ -f "/tmp/trpars-build/images/boot.iso" ]; then
          cp /tmp/trpars-build/images/boot.iso artifacts/
          echo "✓ boot.iso kopyalandı"
        fi
        
        # Tüm ISO dosyalarını ara
        find /tmp/trpars-build -name "*.iso" -type f -exec cp {} artifacts/ \;
        
        # Log dosyalarını kopyala
        cp /tmp/logs/* artifacts/ 2>/dev/null || true
        
        echo "Artifact içeriği:"
        ls -lah artifacts/

    - name: Generate Checksums
      if: always()
      run: |
        if [ -f "artifacts/boot.iso" ]; then
          cd artifacts
          sha256sum boot.iso > TRPars-26.0-Beta.iso.sha256
          md5sum boot.iso > TRPars-26.0-Beta.iso.md5
          echo "✓ Checksumlar oluşturuldu"
        else
          echo "⚠ boot.iso bulunamadı, checksum oluşturulamadı"
        fi

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: /tmp/logs/
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload ISO
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TRPars-26.0-Beta-ISO
        path: artifacts/
        retention-days: 90
        if-no-files-found: ignore

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "╔════════════════════════════════════════╗"
        echo "║      TRPars 26.0 Beta Build Özeti      ║"
        echo "╠════════════════════════════════════════╣"
        echo "║ Tarih: $(date '+%Y-%m-%d %H:%M:%S')     ║"
        echo "║ Durum: Build Tamamlandı                ║"
        echo "║ Artifact'lar: artifacts/ klasöründe    ║"
        echo "╚════════════════════════════════════════╝"
        echo ""
