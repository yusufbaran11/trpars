name: TRPars Build

on:
  workflow_dispatch:
    inputs:
      build_name:
        description: 'Build adı (opsiyonel)'
        required: false
        default: 'Manual Build'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        dnf install -y \
          lorax \
          pykickstart \
          anaconda \
          anaconda-tui \
          git \
          curl \
          createrepo \
          dnf-plugins-core

    - name: Create Build Directories
      run: |
        mkdir -p output
        mkdir -p iso_output/logs
        mkdir -p artifacts

    - name: Validate Kickstart
      run: |
        echo "Kickstart dosyası doğrulanıyor..."
        ksvalidator kickstart/trpars.ks
        echo "✓ Doğrulama başarılı!"

    - name: Build ISO Image
      run: |
        echo "ISO imajı oluşturuluyor..."
        set +e
        
        lorax \
          --product="TRPars" \
          --version="26.0-Beta" \
          --release="26.0-Beta" \
          --ks kickstart/trpars.ks \
          --output-dir output/ \
          --logfile iso_output/logs/lorax.log \
          2>&1 | tee iso_output/logs/build.log
        
        BUILD_STATUS=$?
        
        if [ $BUILD_STATUS -eq 0 ]; then
          echo "✓ ISO oluşturuldu!"
        else
          echo "⚠ Lorax biraz uyarı verdi ama devam ediyor..."
          echo "Build status: $BUILD_STATUS"
        fi
        
        set -e

    - name: Check Build Output
      run: |
        echo "Build output'unu kontrol ediyoruz..."
        find output/ -type f -name "*.iso" 2>/dev/null || echo "ISO output'ta bulunamadı"
        ls -la output/

    - name: Move ISO Files
      run: |
        echo "ISO dosyalarını kopyalıyoruz..."
        
        # Ana output'tan kontrol et
        if [ -d "output/images" ]; then
          mkdir -p iso_output/images
          cp -v output/images/* iso_output/images/ 2>/dev/null || true
        fi
        
        # Boot.iso'yu ara
        find output/ -name "boot.iso" -type f -exec cp {} iso_output/images/ \; 2>/dev/null || true
        
        ls -la iso_output/images/ || echo "ISO imajları bulunamadı"

    - name: Check ISO File
      run: |
        echo "ISO dosyasını kontrol ediyoruz..."
        
        if [ -f "iso_output/images/boot.iso" ]; then
          echo "✓ ISO dosyası bulundu"
          ls -lh iso_output/images/boot.iso
        else
          echo "⚠ boot.iso bulunamadı, alternatif dosyaları arıyoruz..."
          find iso_output -type f -name "*.iso" -ls || true
          find output -type f -name "*.iso" -ls || true
          
          # Hata detaylarını göster
          if [ -f "iso_output/logs/lorax.log" ]; then
            echo "=== Lorax Log ===="
            tail -50 iso_output/logs/lorax.log
          fi
        fi

    - name: Generate Checksums
      if: always()
      run: |
        if [ -f "iso_output/images/boot.iso" ]; then
          cd iso_output/images
          sha256sum boot.iso > TRPars-26.0-Beta.iso.sha256
          md5sum boot.iso > TRPars-26.0-Beta.iso.md5
          echo "✓ Checksumlar oluşturuldu"
          ls -lh
        else
          echo "⚠ ISO dosyası bulunamadığı için checksum oluşturulamadı"
        fi

    - name: Prepare Artifacts
      if: always()
      run: |
        echo "Artifact'lar hazırlanıyor..."
        
        # ISO dosyasını kopyala
        if [ -f "iso_output/images/boot.iso" ]; then
          cp iso_output/images/boot.iso artifacts/ 2>/dev/null || true
        fi
        
        # Checksum dosyalarını kopyala
        cp iso_output/images/*.sha256 artifacts/ 2>/dev/null || true
        cp iso_output/images/*.md5 artifacts/ 2>/dev/null || true
        
        # Log dosyalarını kopyala
        cp iso_output/logs/* artifacts/ 2>/dev/null || true
        
        echo "Artifact içeriği:"
        ls -la artifacts/

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: iso_output/logs/
        retention-days: 14
        if-no-files-found: ignore

    - name: Upload ISO and Checksums
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TRPars-26.0-Beta-ISO
        path: artifacts/
        retention-days: 90
        if-no-files-found: ignore

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "╔════════════════════════════════════╗"
        echo "║   TRPars Build Özeti                ║"
        echo "╠════════════════════════════════════╣"
        echo "║ Sürüm: 26.0 Beta                   ║"
        echo "║ Tarih: $(date '+%Y-%m-%d %H:%M')   ║"
        echo "║ Status: Build Tamamlandı           ║"
        echo "╚════════════════════════════════════╝"
        echo ""
