name: TRPars Build

on:
  workflow_dispatch:
    inputs:
      build_name:
        description: 'Build adı (opsiyonel)'
        required: false
        default: 'Manual Build'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        dnf install -y \
          lorax \
          pykickstart \
          anaconda-tui \
          git \
          curl

    - name: Validate Kickstart
      run: |
        echo "Kickstart dosyası doğrulanıyor..."
        ksvalidator kickstart/trpars.ks
        echo "✓ Doğrulama başarılı!"

    - name: Build ISO Image
      run: |
        echo "ISO imajı oluşturuluyor..."
        mkdir -p output
        lorax \
          -p "TRPars" \
          -v "26.0-Beta" \
          -r "26.0-Beta" \
          --ks kickstart/trpars.ks \
          -o output/ \
          ./iso_output
        echo "✓ ISO oluşturuldu!"

    - name: Generate Checksums
      run: |
        cd iso_output/images
        sha256sum boot.iso > TRPars-26.0-Beta.iso.sha256
        md5sum boot.iso > TRPars-26.0-Beta.iso.md5
        ls -lh boot.iso

    - name: Prepare Artifacts
      run: |
        mkdir -p artifacts
        cp iso_output/images/boot.iso artifacts/
        cp iso_output/images/*.sha256 artifacts/
        cp iso_output/images/*.md5 artifacts/

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: iso_output/logs/
        retention-days: 14
        compression-level: 9

    - name: Upload ISO and Checksums
      uses: actions/upload-artifact@v4
      with:
        name: TRPars-26.0-Beta-ISO
        path: artifacts/
        retention-days: 90
        compression-level: 6

    - name: Build Summary
      if: always()
      run: |
        echo "╔════════════════════════════════════╗"
        echo "║   TRPars Build Özeti                ║"
        echo "╠════════════════════════════════════╣"
        echo "║ Sürüm: 26.0 Beta                   ║"
        echo "║ Tarih: $(date '+%Y-%m-%d %H:%M')   ║"
        echo "║ Status: Build Tamamlandı           ║"
        echo "╚════════════════════════════════════╝"
