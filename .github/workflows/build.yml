name: TRPars Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        echo "Bağımlılıklar yükleniyor..."
        dnf install -y \
          pykickstart \
          anaconda \
          anaconda-core \
          git \
          curl \
          wget \
          xorriso \
          syslinux \
          createrepo_c \
          pungi \
          lorax

    - name: Create Build Directories
      run: |
        echo "Dizinler oluşturuluyor..."
        rm -rf /tmp/trpars-build /tmp/work /tmp/cache /tmp/logs
        mkdir -p /tmp/logs /tmp/work /tmp/cache /tmp/repos
        mkdir -p artifacts
        echo "✓ Hazır"

    - name: Validate Kickstart
      run: |
        echo "Kickstart doğrulanıyor..."
        ksvalidator kickstart/trpars.ks
        echo "✓ Başarılı"

    - name: Setup DNF Cache
      run: |
        echo "DNF cache kurulumu..."
        dnf makecache 2>&1 | tee /tmp/logs/dnf-cache.log
        echo "✓ Cache hazır"

    - name: Build ISO with Lorax (Minimal)
      run: |
        echo "ISO oluşturuluyor..."
        set +e
        
        # Lorax komutu - minimal ama çalışan
        lorax \
          --product=TRPars \
          --version=26.0-Beta \
          --release=26.0-Beta \
          --logfile=/tmp/logs/lorax.log \
          --tmp=/tmp/work \
          --cachedir=/tmp/cache \
          /tmp/trpars-build 2>&1 | tee /tmp/logs/build.log
        
        BUILD_STATUS=$?
        echo "Build status: $BUILD_STATUS"
        set -e

    - name: Check Output
      run: |
        echo "Çıktı kontrol ediliyor..."
        echo ""
        echo "=== /tmp/trpars-build ==="
        ls -lah /tmp/trpars-build/ 2>/dev/null || echo "Bulunamadı"
        
        echo ""
        echo "=== ISO dosyaları ==="
        find /tmp/trpars-build -name "*.iso" -type f -ls 2>/dev/null || echo "ISO yok"
        
        echo ""
        echo "=== İmaj klasörü ==="
        ls -la /tmp/trpars-build/images/ 2>/dev/null || echo "images/ yok"

    - name: Show Logs
      if: always()
      run: |
        echo "=== LAST 400 LINES OF BUILD LOG ==="
        tail -400 /tmp/logs/build.log 2>/dev/null || echo "Log yok"

    - name: Copy ISO
      if: always()
      run: |
        echo "ISO kopyalanıyor..."
        
        if [ -f "/tmp/trpars-build/images/boot.iso" ]; then
          cp /tmp/trpars-build/images/boot.iso artifacts/TRPars-26.0-Beta.iso
          echo "✓ ISO kopyalandı"
          ls -lh artifacts/
        else
          echo "⚠ boot.iso bulunamadı"
        fi
        
        # Log'ları da kopyala
        cp /tmp/logs/* artifacts/ 2>/dev/null || true

    - name: Generate Checksums
      if: always()
      run: |
        if [ -f "artifacts/TRPars-26.0-Beta.iso" ]; then
          cd artifacts
          sha256sum TRPars-26.0-Beta.iso > TRPars-26.0-Beta.iso.sha256
          md5sum TRPars-26.0-Beta.iso > TRPars-26.0-Beta.iso.md5
          echo "✓ Checksumlar oluşturuldu"
          ls -lh
        fi

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: /tmp/logs/
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload ISO
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TRPars-26.0-Beta-ISO
        path: artifacts/
        retention-days: 90
        if-no-files-found: ignore

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "╔════════════════════════════════════╗"
        echo "║   TRPars 26.0 Beta Build Summary   ║"
        echo "╠════════════════════════════════════╣"
        echo "║ Tarih: $(date '+%Y-%m-%d %H:%M')   ║"
        echo "║ Build Tamamlandı                   ║"
        echo "╚════════════════════════════════════╝"
        echo ""
